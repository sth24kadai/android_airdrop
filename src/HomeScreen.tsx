// #region Imports
import React, { Component } from 'react'
import {
	Platform,
	StyleSheet,
	TouchableOpacity,
	Text,
	FlatList,
	RefreshControl,
	View,
} from 'react-native'
import { SafeAreaProvider } from 'react-native-safe-area-context';
import SafeAreaView from 'react-native-safe-area-view';
import { Icon, ListItem } from 'react-native-elements'
import Zeroconf, { Service } from 'react-native-zeroconf'
import { BridgeServer } from 'react-native-http-bridge-refurbished';
import {
	ActivityIndicator,
	Button as PaperButton
} from 'react-native-paper';
import { Buffer } from 'buffer';
import { NativeStackScreenProps } from "react-native-screens/lib/typescript/native-stack/types";

import { RootStackParamList } from '../types';
import { Context } from '../components/context';
// #endregion


const zeroconf = new Zeroconf()

/**
 * ã‚¢ãƒ—ãƒªã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
 */
export default class App extends Component<NativeStackScreenProps<RootStackParamList, 'ãƒ‡ãƒã‚¤ã‚¹ã®é¸æŠ'>> {
	static contextType = Context;
	//@ts-ignore
	context!: React.ContextType<typeof Context>
	/**
	 * Zeroconfã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ãƒãƒ³ãƒ‰ãƒ©å¤‰æ•°	
	 */
	public timeout: NodeJS.Timeout | undefined = void 0

	/**
	 * ä½¿ç”¨ã™ã‚‹ãƒãƒ¼ãƒˆ
	 */
	public AIRDROP_HTTP_PORT = 8771

	/**
	 * HTTPã‚µãƒ¼ãƒãƒ¼ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
	 */
	private __BridgeServer: BridgeServer | null = null

	// #region Static Functions
	/**
	 * ãƒ‡ãƒã‚¤ã‚¹ã®ç¨®é¡ã‚’å–å¾—ã—ã¾ã™ã€‚
	 * ä¾å­˜ã—ãªã„staticãªé–¢æ•°
	 */
	static get deviceType(): number {
		const device = Platform.OS;
		switch (device) {
			case "android": return 1;
			case "ios": return 1;
			case "macos": return 3;
			case "windows": return 3;
			case "web": return 0;
			default: return 0;
		}
	}

	/**
	 * TXTãƒ¬ã‚³ãƒ¼ãƒ‰ã®å€¤ã‚’ç”Ÿæˆã—ã¾ã™ã€‚ 
	 */
	static TXTRecodeValue(): Uint8Array {
		// Generated by Github Copilot :)
		const version = 0;
		const visibility = 0;
		const deviceType = App.deviceType;
		const reserved = 0;
		const bitField = (version << 5) | (visibility << 4) | (deviceType << 1) | reserved;

		// 16ãƒã‚¤ãƒˆã®ãƒ©ãƒ³ãƒ€ãƒ ãªå€¤ã‚’ç”Ÿæˆ
		const randomBytes = new Uint8Array(16);
		for (let i = 0; i < 16; i++) {
			randomBytes[i] = Math.floor(Math.random() * 256);
		}

		// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã‚‹ã“ã¨ãŒã§ãã‚‹ãƒ‡ãƒã‚¤ã‚¹åã‚’UTF-8ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã€ãã®é•·ã•ï¼ˆ1ãƒã‚¤ãƒˆï¼‰ã‚’ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã¨ã—ã¦è¿½åŠ 
		let nameChars = new TextEncoder().encode("Nearby Share Development Device");
		if (nameChars.length > 255) {
			nameChars = nameChars.slice(0, 255);
		}
		const nameLength = nameChars.length;

		// ã™ã¹ã¦ã‚’1ã¤ã®Uint8Arrayã«çµåˆ
		const EndpointInfo = new Uint8Array(1 + 16 + 1 + nameChars.length);
		EndpointInfo[0] = bitField;
		EndpointInfo.set(randomBytes, 1);
		EndpointInfo[17] = nameLength;
		EndpointInfo.set(nameChars, 18);

		return EndpointInfo;
	}




	// #endregion

	// #region Component Mount
	/**
	 * Reactã®é–¢æ•°
	 * ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒãƒã‚¦ãƒ³ãƒˆã•ã‚ŒãŸã¨ãã«ç™ºç«ã™ã‚‹
	 */
	componentDidMount() {
		// #region mDNS Configuration
		/* HTTPã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã€€*/

		/* ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸãƒ•ã‚§ãƒƒãƒ */
		this.refreshData()

		/**
		 * mDNSã®TXTãƒ¬ã‚³ãƒ¼ãƒ‰
		 */
		const textRecode = App.TXTRecodeValue()

		/* mDNSã‚µãƒ¼ãƒ“ã‚¹ã‚’é–‹å§‹ */
		zeroconf.publishService(
			/* ã‚µãƒ¼ãƒ“ã‚¹å */
			'FC9F5ED42C8A',
			/* ãƒ—ãƒ­ãƒˆã‚³ãƒ« */
			'tcp',
			/* ãƒ‰ãƒ¡ã‚¤ãƒ³ */
			'local.',
			/* ãƒ›ã‚¹ãƒˆå */
			Buffer.from(textRecode).toString('base64'),
			/* ä½¿ç”¨ãƒãƒ¼ãƒˆ */
			5353,
			/* TXTãƒ¬ã‚³ãƒ¼ãƒ‰ */
			{
				n: Buffer.from(textRecode).toString('base64'),
			}
		)

		console.log(
			`EndpointInfo: ${Buffer.from(textRecode).toString("base64")}`
		)

		//#endregion
		// #region mDNS Event Handlers

		/* mDNSã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ© */
		zeroconf.on('start', () => {
			this.context.setObjectState({ isScanning: true })
			this.context.logs.push({
				emoji: 'ğŸ”',
				message: 'Started scanning and lunching the mDNS service...'
			})

		})

		zeroconf.on('stop', () => {
			this.context.setObjectState({ isScanning: false })
			this.context.logs.push({
				emoji: 'ğŸ›‘',
				message: 'Stopped scanning'
			})
		})

		zeroconf.on('update', () => {
			this.context.logs.push({
				emoji: 'ğŸ”„',
				message: 'Updating Data...'
			})
		})

		zeroconf.on('resolved', async service => {
			this.context.logs.push({
				emoji: 'ğŸ‰',
				message: `Resolved ${service.name} (${service.host})`
			})
			this.context.logs.push({
				emoji: 'ğŸ”—',
				message: JSON.stringify(service)
			})

			const deviceName = await this.getDeviceName(service)
			if (deviceName !== null) {
				this.context.logs.push({
					emoji: 'ğŸ“±',
					message: `Fetch Success: ${JSON.stringify(deviceName.data.clientId)} -  ${deviceName.data.clientName} (${deviceName.data.clientModel})`
				})
			}

			const newService = Object.assign(service, deviceName !== null ? deviceName.data : {}) as Service & { clientName: string, clientModel: string }

			this.context.setObjectState({
				services: {
					...this.context.services,
					[service.host]: newService,
				},
			})
		})


		zeroconf.on('error', err => {
			this.context.setObjectState({ isScanning: false })
			this.context.logs.push({
				emoji: 'ğŸš¨',
				message: `Error: ${err}`
			})
		})
	}

	//#endregion
	/**
	 * 
	 * ãƒ‡ãƒã‚¤ã‚¹åã‚’å–å¾—ã™ã‚‹é–¢æ•°ã€‚serviceã‚’å¼•æ•°ã«å–ã‚Šã€Promiseã‚’è¿”ã—ã¾ã™ã€‚
	 * 
	 * @param {Service} service - ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±
	 */
	async getDeviceName(service: Service) {
		const response = await fetch(`http://${service.host}:${this.AIRDROP_HTTP_PORT}/info`)
			.catch(err => {
				this.context.logs.push({
					emoji: 'ğŸš¨',
					message: `Error on getDeviceName : ${err}`
				})
				return null;
			});
		if (response === null) return null;

		if (response.ok) {
			const data = await response.json() as { status: string, data: { clientId: string, clientName: string, clientModel: string } };
			return data;
		}

		return null;
	}

	/**
	 * Reactã®é–¢æ•°
	 * ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆã•ã‚ŒãŸã¨ãã«ç™ºç«ã™ã‚‹
	 */
	componentWillUnmount() {
		this.context.logs.push({
			emoji: 'ğŸ›‘',
			message: 'Unmounting the component and stopping the mDNS service...'
		})

		this.__BridgeServer !== null && this.__BridgeServer.stop()
		zeroconf.stop();
	}

	//#region Components 
	//#region Render

	/**
	 * ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§ã®ãƒ¬ãƒ³ãƒ€ãƒ¼
	 */
	renderRow = ({ item, index }: { item: string, index: number }) => {
		const { name, fullName, host, addresses, clientModel, clientName } = this.context.services[item]

		return (
			<TouchableOpacity
				onPress={() => {
					this.context.setObjectState({
						selectedService: host,
					});
					this.props.navigation.navigate('DetailScreen');
				}}
				style={[styles.textWithIcon, styles.upadding]}
			>
				<Icon name="smartphone" size={35} />
				<ListItem.Content>
					<ListItem.Title style={styles.titleButSmall}>{clientName ?? fullName.split('.')[0]}</ListItem.Title>
					<ListItem.Subtitle>{fullName} / {addresses.join(',')}</ListItem.Subtitle>
				</ListItem.Content>
			</TouchableOpacity>	
		)
	}

	// #endregion

	refreshData = () => {
		const { isScanning } = this.context
		if (isScanning) {
			return
		}
		this.context.setObjectState({ services: {} })

		zeroconf.scan('FC9F5ED42C8A', 'tcp', 'local.')
		this.context.logs.push({
			emoji: 'ğŸ”â™»ï¸',
			message: 'ReScanning for services...'
		})

		clearTimeout(this.timeout)
		this.timeout = setTimeout(() => {
			zeroconf.stop()
		}, 5000)
	}

	render() {
		const { services, selectedService, isScanning } = this.context

		return (
			<SafeAreaProvider>
				<SafeAreaView style={styles.container}>
					<Text style={styles.title}> NearDrop </Text>
					<View style={styles.flexColumn}>
						<Text style={styles.udpadding}>æ¤œå‡ºã•ã‚ŒãŸãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§</Text>
						{
							isScanning ? (
								<>
									<View style={styles.textWithIconNotBackground}>
										<ActivityIndicator size="small" />
										<Text>ä»˜è¿‘ã®ãƒ‡ãƒã‚¤ã‚¹ã‚’æ¤œç´¢ä¸­</Text>
									</View>
								</>
							) : (
								<>
									<FlatList
										data={Object.keys(services)}
										renderItem={this.renderRow}
										keyExtractor={key => key}
										refreshControl={
											<RefreshControl
												refreshing={isScanning}
												onRefresh={this.refreshData}
												tintColor="skyblue"
											/>
										}
									/>
								</>
							)
						}
					</View>
					<View style={styles.udpadding}>
					{ !isScanning && (
						<View style={styles.flexColumn}>
							<PaperButton icon="image" mode='contained-tonal' onPress={() => this.props.navigation.navigate("å†™çœŸã®ä¿å­˜")}>
								å†™çœŸã‚’è¦‹ã‚‹
							</PaperButton>
							<PaperButton icon="reload" mode='contained-tonal' onPress={() => this.refreshData()}>
								ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹
							</PaperButton>
							<PaperButton icon="archive" mode='contained-tonal' onPress={() => this.props.navigation.navigate('LogScreen')}>
								ãƒ‡ãƒãƒƒã‚¯ãƒ­ã‚°ã‚’ç¢ºèªã™ã‚‹
							</PaperButton>
						</View>
					)}
					</View>
				</SafeAreaView>
			</SafeAreaProvider>
		)
	}

	//#endregion
}

//#region Styles

const styles = StyleSheet.create({
	title: {
		fontSize: 30,
		paddingTop: 10,
		paddingBottom: 10,
	},
	titleButSmall: {
		fontSize: 20,
	},
	flexColumn: {
		display: 'flex',
		flexDirection: 'column',
		gap: 10
	},
	upadding: {
		paddingTop: 10,
	},
	udpadding: {
		paddingTop: 10,
		paddingBottom: 10
	},
	textWithIconNotBackground: {
		display: 'flex',
		flexDirection: 'row',
		alignContent: 'center',
		alignItems: 'center',
		textAlign: 'center',
		justifyContent: 'center',
		gap: 10,
		fontSize: 30,
	},
	textWithIcon: {
		display: 'flex',
		flexDirection: 'row',
		alignContent: 'center',
		alignItems: 'center',
		textAlign: 'center',
		justifyContent: 'center',
		gap: 10,
		fontSize: 30,
		padding: 10,
		backgroundColor: '#f0f0f0',
		borderRadius: 10
	},

	textWithIconSizeFree: {
		padding: 10,
		display: 'flex',
		flexDirection: 'row',
		alignContent: 'center',
		alignItems: 'center',
		textAlign: 'center',
		justifyContent: 'center',
		gap: 10,
	},
	container: {
		flex: 1,
		marginTop: 10,
		marginLeft: 10,
		marginRight: 10,
		marginBottom: 10,
	},
	closeButton: {
		padding: 20,
		textAlign: 'center',
	},
	json: {
		padding: 6,
		fontWeight: "bold",
		fontSize: 15,
	},
	logs: {
		padding: 3,
		fontSize: 20,
		fontWeight: "semibold"
	},
	state: {
		fontSize: 20,
		textAlign: 'center',
		margin: 30,
	},
	flexLog: {
		display: 'flex',
		flexDirection: "row",
		alignContent: "center"
	}
})

App.contextType = Context

//#endregion